{% extends '/Layouts/base.html' %}

{% block title %}Registro{% endblock %}

{% block content %}
<style>
    .image-preview-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }
    .image-preview {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .error-message {
        color: red;
        font-size: 12px;
        margin-top: 5px;
        display: none;
    }
    .error-border {
        border-color: red;
    }
</style>
<br>
<div class="register-section">
    <div class="register-left">
        <div class="alert-container">
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="custom-alert custom-alert-{{ category }}">
                        {{ message }}
                        <button class="close-btn">&times;</button>
                    </div>
                {% endfor %}
            {% endif %}
            {% endwith %}
        </div>
        <h1>Registro de Negocio</h1>
        <p>Complete el formulario para registrar su negocio.</p>
      
        <form id="registro-form" action="/Authentication/register" method="POST" enctype="multipart/form-data" onsubmit="return submitForm(event)">
            <div id="parte-1">
                <div class="form-group">
                    <label for="business_name">Nombre del Negocio</label>
                    <input type="text" id="business_name" placeholder="Nombre del Negocio" name="business_name" required minlength="3" maxlength="100">
                    <span id="error-business_name" class="error-message">Este campo es obligatorio.</span>
                </div>

                <div class="form-group">
                    <label for="owner_name">Nombre del Propietario</label>
                    <input type="text" id="owner_name" placeholder="Nombre del Propietario" name="owner_name" required minlength="3" maxlength="100">
                    <span id="error-owner_name" class="error-message">Este campo es obligatorio.</span>
                </div>

                <div class="form-group">
                    <label for="email">Correo Electrónico</label>
                    <input type="email" id="email" placeholder="Correo Electrónico" name="email" required>
                    <span id="error-email" class="error-message">Este campo es obligatorio.</span>
                </div>

                <div class="form-group">
                    <label for="password">Contraseña</label>
                    <input type="password" class="form-control" id="password" name="password" placeholder="Contraseña" required minlength="8">
                    <small>La contraseña debe tener al menos 8 caracteres, incluyendo una mayúscula, una minúscula, un número y un carácter especial.</small>
                    <span id="error-password" class="error-message">La contraseña no cumple con los requisitos.</span>
                </div>

                <div class="form-group">
                    <label for="phone_number">Número de Teléfono</label>
                    <input type="tel" id="phone" placeholder="Número de Teléfono" name="phone_number" required pattern="[0-9]{10}">
                    <small>Formato: 10 dígitos sin espacios ni guiones</small>
                    <span id="error-phone" class="error-message">Formato de teléfono inválido.</span>
                </div>

                <div class="form-group">
                    <label for="business_address">Dirección del negocio</label>
                    <input type="text" id="address" placeholder="Dirección" name="business_address" required minlength="5" maxlength="200">
                    <span id="error-address" class="error-message">Este campo es obligatorio.</span>
                </div>

                <button type="button" onclick="nextPart()" class="btn-r submit-btn-register">Siguiente</button>
            </div>

            <div id="parte-2" style="display: none;">
                <div class="form-group">
                    <label for="services_offered">Servicios Ofrecidos</label>
                    <select id="services_offered" name="services_offered" required>
                        <option value="">Seleccione un servicio</option>
                        <option value="Estetica">Estética</option>
                        <option value="Peluqueria">Peluquería</option>
                        <option value="Salon">Salón de Belleza</option>
                    </select>   
                    <span id="error-services_offered" class="error-message">Este campo es obligatorio.</span>
                </div>

                <div class="form-group">
                    <label>Horario de servicio</label>
                    <div class="turno-container">
                        <div class="turno">
                            <h4>Primer Turno</h4>
                            <div class="time-selection">
                                <label for="opening_time_1">Hora de apertura:</label>
                                <input type="time" id="opening_time_1" name="opening_time_1" required>
                                <label for="closing_time_1">Hora de cierre:</label>
                                <input type="time" id="closing_time_1" name="closing_time_1" required>
                            </div>
                            <span id="error-turno_1" class="error-message">El horario no es válido.</span>
                        </div>
                        <div class="turno">
                            <h4>Segundo Turno</h4>
                            <div class="time-selection">
                                <label for="opening_time_2">Hora de apertura:</label>
                                <input type="time" id="opening_time_2" name="opening_time_2">
                                <label for="closing_time_2">Hora de cierre:</label>
                                <input type="time" id="closing_time_2" name="closing_time_2">
                            </div>
                            <span id="error-turno_2" class="error-message">El horario no es válido.</span>
                        </div>
                    </div>
                </div>

                <div class="note">
                    <p>Mínimo 3 imágenes del negocio</p>
                </div>
                <div class="image-upload-container">
                    <label for="business-image-upload" class="image-upload-label">Imágenes de negocio</label>
                    <input type="file" id="business-image-upload" name="business-image-upload" class="image-upload-input" accept="image/*" multiple required>
                    <div id="business-image-preview" class="image-preview-container"></div>
                    <span id="error-business-images" class="error-message">Debe subir al menos 3 imágenes.</span>
                </div>

                <div class="note">
                    <p>Mínimo 3 imágenes de Servicios</p>
                </div>
                <div class="image-upload-container">
                    <label for="service-image-upload" class="image-upload-label">Imágenes de servicio</label>
                    <input type="file" id="service-image-upload" name="service-image-upload" class="image-upload-input" accept="image/*" multiple required>
                    <div id="service-image-preview" class="image-preview-container"></div>
                    <span id="error-service-images" class="error-message">Debe subir al menos 3 imágenes.</span>
                </div>

                <div class="note">
                    <p>Mínimo una Imagen para foto del perfil del negocio</p>
                </div>
                <div class="image-upload-container">
                    <label for="profile-image-upload" class="image-upload-label">Foto de Perfil</label>
                    <input type="file" id="profile-image-upload" name="profile-image-upload" class="image-upload-input" accept="image/*" required>
                    <div id="profile-image-preview" class="image-preview-container"></div>
                    <span id="error-profile-image" class="error-message">Debe subir una imagen de perfil.</span>
                </div>

                <div class="note-register">
                    <p>Nota: Este negocio está registrado por Google Maps.</p>
                </div>
            
                <div class="terms-container">
                    <input type="checkbox" id="accept-terms" name="accept-terms" required>
                    <label for="accept-terms">Aceptar Términos y condiciones</label>
                    <a href="#" class="terms-link">Leer Políticas</a>
                    <span id="error-accept-terms" class="error-message">Debe aceptar los términos y condiciones.</span>
                </div>
            
                <div class="buttons-register">
                    <button type="button" onclick="prevPart()" class="btn-r submit-btn-register">Anterior</button>
                    <button type="submit" id="submit-btn" class="btn-r submit-btn-register">Registrar</button>
                </div>
            </div>
        </form>
    </div>

    <div class="register-right">
        <img src="{{ url_for('static', filename='img/bannerregister.jpg') }}" alt="Imagen del Negocio">
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    function handleImageUpload(inputId, previewId) {
        const input = document.getElementById(inputId);
        const previewContainer = document.getElementById(previewId);
        
        input.addEventListener('change', function() {
            previewContainer.innerHTML = '';
            if (input.files.length > 0) {
                Array.from(input.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.classList.add('image-preview');
                        previewContainer.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                });
            }
        });
    }

    handleImageUpload('business-image-upload', 'business-image-preview');
    handleImageUpload('service-image-upload', 'service-image-preview');
    handleImageUpload('profile-image-upload', 'profile-image-preview');
});

function nextPart() {
    const fields = document.querySelectorAll('#parte-1 input');
    let isValid = true;

    fields.forEach(field => {
        const errorElement = document.getElementById('error-' + field.id);
        if (!field.checkValidity()) {
            field.classList.add('error-border');
            errorElement.style.display = 'block';
            isValid = false;
        } else {
            field.classList.remove('error-border');
            errorElement.style.display = 'none';
        }
    });

    if (isValid) {
        document.getElementById('parte-1').style.display = 'none';
        document.getElementById('parte-2').style.display = 'block';
    }
}

function prevPart() {
    document.getElementById('parte-1').style.display = 'block';
    document.getElementById('parte-2').style.display = 'none';
}

function validateTimeRange(openingId, closingId, errorId) {
    const openingTime = document.getElementById(openingId).value;
    const closingTime = document.getElementById(closingId).value;
    const errorElement = document.getElementById(errorId);

    if (openingTime && closingTime && openingTime >= closingTime) {
        errorElement.style.display = 'block';
        return false;
    } else {
        errorElement.style.display = 'none';
        return true;
    }
}

function submitForm(event) {
    const timeValid1 = validateTimeRange('opening_time_1', 'closing_time_1', 'error-turno_1');
    const timeValid2 = validateTimeRange('opening_time_2', 'closing_time_2', 'error-turno_2');

    const imageUploads = [
        { id: 'business-image-upload', minFiles: 3, errorId: 'error-business-images' },
        { id: 'service-image-upload', minFiles: 3, errorId: 'error-service-images' },
        { id: 'profile-image-upload', minFiles: 1, errorId: 'error-profile-image' }
    ];

    let imagesValid = true;
    imageUploads.forEach(upload => {
        const input = document.getElementById(upload.id);
        const errorElement = document.getElementById(upload.errorId);
        if (input.files.length < upload.minFiles) {
            errorElement.style.display = 'block';
            imagesValid = false;
        } else {
            errorElement.style.display = 'none';
        }
    });

    const acceptTerms = document.getElementById('accept-terms');
    const termsError = document.getElementById('error-accept-terms');
    const termsValid = acceptTerms.checked;

    if (!termsValid) {
        termsError.style.display = 'block';
    } else {
        termsError.style.display = 'none';
    }

    if (!timeValid1 || !timeValid2 || !imagesValid || !termsValid) {
        event.preventDefault();
        return false;
    }

    return true;
}
</script>
{% endblock %}
